// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  firebaseUid           String?  @unique
  subscriptionTier      String   @default("free") // "free" or "pro"
  stripeCustomerId      String?  @unique
  stripePriceId         String?
  subscriptionStatus    String?  // "active", "trialing", "past_due", "canceled"
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  listings              Listing[]
  transactions          Transaction[]
  templates             MessageTemplate[]

  @@map("users")
}

model Listing {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  airbnbListingId       String
  name                  String
  address               String?
  pmsConnectionId       String?
  pmsProvider           String?   // "hostaway", "guesty", "lodgify"
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  transactions          Transaction[]

  @@unique([userId, airbnbListingId])
  @@map("listings")
}

model Task {
  id                    String   @id @default(cuid())
  userId                String
  listingId             String
  type                  String   // "refill", "clean", "maintenance", "message", "custom"
  title                 String
  status                String   @default("pending") // "pending", "in-progress", "completed"
  dueDate               DateTime?
  notes                 String?
  aiGenerated           Boolean  @default(false)
  sourceMessageId       String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("tasks")
}

model MessageTemplate {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                  String
  category              String   // "checkin", "checkout", "issues", "general"
  content               String
  variables             String?  // JSON string of allowed variables
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("message_templates")
}

model Transaction {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId             String
  listing               Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  amount                Float
  type                  String   // "income", "expense", "payout"
  category              String?
  description           String?
  payoutStatus          String?  // "pending", "completed", "failed"
  payoutMethod          String?  // "stripe_connect", "bank_transfer"
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("transactions")
}
